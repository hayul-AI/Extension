<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Converter Tool - Free & Secure Online Tool</title>
    <meta name="description" content="Free online image converter. Convert HEIC to JPG, WEBP to JPG, PNG to JPG, compress images, extract text with OCR, merge JPG to PDF, and generate favicons securely in your browser.">
    <meta name="keywords" content="image converter, HEIC to JPG, WEBP to JPG, image compression, free OCR, extract text from image, JPG to PDF, favicon maker, browser-based converter">
    <meta property="og:title" content="Image Converter Tool - Free & Secure Browser-based Utility">
    <meta property="og:description" content="Convert and edit images directly on your device without uploading to a server. Supports HEIC, WEBP, Compression, OCR, PDF, and more.">
    <meta property="og:type" content="website">
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "SoftwareApplication",
      "name": "Image Converter Tool",
      "applicationCategory": "MultimediaApplication",
      "operatingSystem": "Web Browser",
      "offers": {
        "@type": "Offer",
        "price": "0",
        "priceCurrency": "USD"
      },
      "description": "Browser-based free image conversion, compression, and OCR tool. Use securely without server uploads.",
      "featureList": "HEIC to JPG, WEBP to JPG, Image Compression, OCR, Image to PDF, Favicon Generator"
    }
    </script>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6460078490158642"
     crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/heic2any/0.0.4/heic2any.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <style>
        :root {
            --primary-color: #007bff;
            --secondary-color: #6c757d;
            --background-color: #f8f9fa;
            --text-color: #212529;
            --border-color: #dee2e6;
            --success-color: #28a745;
            --error-color: #dc3545;
            --card-bg: #ffffff;
            --font-size: 18px;
            --container-width: 95%;
            --max-width: 1200px;
            --shadow-color: rgba(0,0,0,0.08);
        }

        [data-theme="dark"] {
            --background-color: #121212;
            --text-color: #e0e0e0;
            --border-color: #333333;
            --card-bg: #1e1e1e;
            --secondary-color: #a0a0a0;
            --shadow-color: rgba(0,0,0,0.4);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--background-color);
            color: var(--text-color);
            font-size: var(--font-size);
            line-height: 1.6;
            transition: background-color 0.3s, color 0.3s;
        }
        .container {
            width: var(--container-width);
            max-width: var(--max-width);
            margin: 0 auto;
            padding: 2rem 1rem;
        }
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            gap: 1rem;
        }
        .header-title {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        .site-logo {
            width: 48px;
            height: 48px;
            fill: var(--primary-color);
        }
        h1 {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--primary-color);
            margin: 0;
        }
        .theme-toggle {
            background: none;
            border: 2px solid var(--primary-color);
            color: var(--primary-color);
            padding: 0.6rem 1.2rem;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.3s ease;
            font-size: 1rem;
        }
        .theme-toggle:hover {
            background-color: var(--primary-color);
            color: white;
        }
        .tabs {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 0.8rem;
            margin-bottom: 2rem;
        }
        .tab-button {
            padding: 0.8rem 1.5rem;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            border: 2px solid var(--primary-color);
            background-color: var(--card-bg);
            color: var(--primary-color);
            border-radius: 50px;
            transition: all 0.3s ease;
        }
        .tab-button:hover, .tab-button.active {
            background-color: var(--primary-color);
            color: white;
        }
        .tab-content {
            display: none;
            padding: 2rem;
            border: 1px solid var(--border-color);
            border-radius: 12px;
            background-color: var(--card-bg);
            box-shadow: 0 8px 24px var(--shadow-color);
        }
        .tab-content.active {
            display: block;
        }
        .file-drop-area {
            border: 3px dashed var(--border-color);
            border-radius: 12px;
            padding: 4rem 2rem;
            text-align: center;
            transition: all 0.3s ease;
            background-color: rgba(0,0,0,0.02);
        }
        .file-drop-area.dragover {
            border-color: var(--primary-color);
            background-color: rgba(0, 123, 255, 0.1);
        }
        .file-input {
            display: none;
        }
        .file-label {
            display: inline-block;
            padding: 1rem 2rem;
            background-color: var(--primary-color);
            color: white;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s;
            font-weight: 600;
            margin-top: 1rem;
        }
        .file-label:hover {
            background-color: #0056b3;
        }
        .convert-button {
            display: block;
            width: 100%;
            padding: 1.2rem;
            font-size: 1.3rem;
            font-weight: bold;
            background-color: var(--success-color);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 1.5rem;
            transition: all 0.3s ease;
        }
        .convert-button:hover:not(:disabled) {
            background-color: #218838;
            transform: translateY(-2px);
        }
        .convert-button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .progress-bar {
            width: 100%;
            height: 24px;
            background-color: var(--border-color);
            border-radius: 12px;
            margin-top: 1.5rem;
            overflow: hidden;
            display: none;
            position: relative;
        }
        .progress-bar-inner {
            width: 0;
            height: 100%;
            background-color: var(--primary-color);
            transition: width 0.3s ease;
        }
        .progress-text {
            position: absolute;
            width: 100%;
            text-align: center;
            font-size: 0.9rem;
            font-weight: bold;
            color: #000;
            line-height: 24px;
            mix-blend-mode: difference;
        }
        .results {
            margin-top: 2rem;
        }
        .result-item {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            padding: 1.5rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 1rem;
            background-color: var(--background-color);
            flex-wrap: wrap;
        }
        .result-item img {
            max-width: 120px;
            max-height: 120px;
            object-fit: contain;
            border-radius: 5px;
            background: #eee;
        }
        .result-info {
            flex-grow: 1;
            min-width: 200px;
        }
        .download-button {
            padding: 0.8rem 1.5rem;
            background-color: var(--primary-color);
            color: white;
            text-decoration: none;
            border-radius: 8px;
            font-weight: 600;
            transition: background-color 0.3s;
        }
        .download-button:hover {
            background-color: #0056b3;
        }
        .error-message {
            color: var(--error-color);
            margin-top: 1rem;
            font-weight: 600;
            padding: 1rem;
            background-color: rgba(220, 53, 69, 0.1);
            border-radius: 8px;
            display: none;
        }
        .options {
            margin-top: 1.5rem;
            padding: 1.5rem;
            background-color: var(--background-color);
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        .option-group {
            display: flex;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
        }
        .option-group label {
            font-weight: 600;
            min-width: 120px;
        }
        .option-group input[type="range"] {
            flex-grow: 1;
            max-width: 300px;
        }
        .option-group select {
            padding: 0.5rem;
            border-radius: 5px;
            border: 1px solid var(--border-color);
            background: var(--card-bg);
            color: var(--text-color);
            font-size: 1rem;
        }
        .preset-buttons {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        .preset-btn {
            padding: 0.5rem 1rem;
            border: 1px solid var(--primary-color);
            background: transparent;
            color: var(--primary-color);
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
        }
        .preset-btn:hover, .preset-btn.active {
            background: var(--primary-color);
            color: white;
        }
        
        /* OCR Specific */
        #ocr-result-area {
            width: 100%;
            height: 300px;
            margin-top: 1rem;
            padding: 1rem;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background-color: var(--card-bg);
            color: var(--text-color);
            font-family: monospace;
            font-size: 1rem;
            resize: vertical;
        }
        .ocr-controls {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }
        .ocr-btn {
            flex: 1;
            min-width: 120px;
            padding: 0.8rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: opacity 0.3s;
        }
        .ocr-btn.copy { background-color: var(--primary-color); color: white; }
        .ocr-btn.download { background-color: var(--success-color); color: white; }
        .ocr-btn.reset { background-color: var(--secondary-color); color: white; }
        .ocr-btn:hover { opacity: 0.9; }

        .preprocessing-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.95rem;
        }

        footer {
            text-align: center;
            margin-top: 3rem;
            padding-top: 2rem;
            border-top: 1px solid var(--border-color);
            color: var(--secondary-color);
        }
        footer p { margin-bottom: 1rem; }
        footer a { color: var(--primary-color); text-decoration: none; margin: 0 0.8rem; font-weight: 600; }

        @media (max-width: 768px) {
            h1 { font-size: 1.8rem; }
            .tab-button { font-size: 0.9rem; padding: 0.6rem 1rem; }
            .tab-content { padding: 1.2rem; }
            .file-drop-area { padding: 2.5rem 1rem; }
            .option-group { flex-direction: column; align-items: flex-start; }
            .option-group input[type="range"] { max-width: 100%; width: 100%; }
        }
    </style>
</head>
<body>

    <div class="container">
        <header>
            <h1>Image Tools</h1>
            <button class="theme-toggle" id="theme-toggle" aria-label="Toggle Theme">
                <span class="theme-icon">ðŸŒ™</span>
                <span class="theme-text">Dark Mode</span>
            </button>
        </header>

        <nav class="tabs">
            <button class="tab-button active" data-tab="heic-to-jpg">HEIC â†’ JPG</button>
            <button class="tab-button" data-tab="webp-to-jpg">WEBP â†’ JPG</button>
            <button class="tab-button" data-tab="png-to-jpg">PNG â†’ JPG</button>
            <button class="tab-button" data-tab="jpg-to-png">JPG â†’ PNG</button>
            <button class="tab-button" data-tab="compress">Compress</button>
            <button class="tab-button" data-tab="ocr">OCR (Text)</button>
            <button class="tab-button" data-tab="jpg-to-pdf">JPG â†’ PDF</button>
            <button class="tab-button" data-tab="favicon">Favicon</button>
        </nav>

        <!-- Google AdSense - Top Responsive Ad -->
        <div style="margin: 20px 0; text-align: center;">
            <ins class="adsbygoogle"
                 style="display:block"
                 data-ad-client="ca-pub-6460078490158642"
                 data-ad-slot="auto"
                 data-ad-format="auto"
                 data-full-width-responsive="true"></ins>
            <script>
                 (adsbygoogle = window.adsbygoogle || []).push({});
            </script>
        </div>

        <main>
            <!-- Tab Content: HEIC to JPG -->
            <div id="heic-to-jpg" class="tab-content active">
                <h2>Convert HEIC to JPG</h2>
                <div class="file-drop-area">
                    <input type="file" class="file-input" multiple accept=".heic, .heif">
                    <p>Drag and drop HEIC files here or</p>
                    <label class="file-label">Select Files</label>
                </div>
                <button class="convert-button" disabled>Convert Now</button>
                <div class="progress-bar"><div class="progress-bar-inner"></div><div class="progress-text">0%</div></div>
                <div class="error-message"></div>
                <div class="results"></div>
            </div>

            <!-- Tab Content: WEBP to JPG -->
            <div id="webp-to-jpg" class="tab-content">
                <h2>Convert WEBP to JPG</h2>
                <div class="file-drop-area">
                    <input type="file" class="file-input" multiple accept=".webp">
                    <p>Drag and drop WEBP files here or</p>
                    <label class="file-label">Select Files</label>
                </div>
                <button class="convert-button" disabled>Convert Now</button>
                <div class="progress-bar"><div class="progress-bar-inner"></div><div class="progress-text">0%</div></div>
                <div class="error-message"></div>
                <div class="results"></div>
            </div>
            
            <!-- Tab Content: PNG to JPG -->
            <div id="png-to-jpg" class="tab-content">
                <h2>Convert PNG to JPG</h2>
                <div class="file-drop-area">
                    <input type="file" class="file-input" multiple accept=".png">
                    <p>Drag and drop PNG files here or</p>
                    <label class="file-label">Select Files</label>
                </div>
                <div class="options">
                    <div class="option-group">
                        <label for="png-to-jpg-quality">Quality (0.1-1.0):</label>
                        <input type="range" id="png-to-jpg-quality" min="0.1" max="1.0" value="0.92" step="0.01">
                        <span class="quality-value">0.92</span>
                    </div>
                </div>
                <button class="convert-button" disabled>Convert Now</button>
                <div class="progress-bar"><div class="progress-bar-inner"></div><div class="progress-text">0%</div></div>
                <div class="error-message"></div>
                <div class="results"></div>
            </div>

            <!-- Tab Content: JPG to PNG -->
            <div id="jpg-to-png" class="tab-content">
                 <h2>Convert JPG to PNG</h2>
                <div class="file-drop-area">
                    <input type="file" class="file-input" multiple accept=".jpg, .jpeg">
                    <p>Drag and drop JPG files here or</p>
                    <label class="file-label">Select Files</label>
                </div>
                <button class="convert-button" disabled>Convert Now</button>
                <div class="progress-bar"><div class="progress-bar-inner"></div><div class="progress-text">0%</div></div>
                <div class="error-message"></div>
                <div class="results"></div>
            </div>

            <!-- Tab Content: Image Compression -->
            <div id="compress" class="tab-content">
                <h2>Compress Images (Reduce Size)</h2>
                <div class="file-drop-area">
                    <input type="file" class="file-input" multiple accept=".jpg, .jpeg, .png, .webp">
                    <p>Drag and drop images here or</p>
                    <label class="file-label">Select Files</label>
                </div>
                 <div class="options">
                    <div class="option-group">
                        <label for="compress-quality">Quality Setting:</label>
                        <input type="range" id="compress-quality" min="0.4" max="0.95" value="0.8" step="0.01">
                        <span class="quality-value">0.8</span>
                    </div>
                    <div class="option-group">
                        <label for="compress-resize">Resize (Width):</label>
                        <select id="compress-resize">
                            <option value="original">Original Size</option>
                            <option value="1920">1920px (Full HD)</option>
                            <option value="1280">1280px (HD)</option>
                            <option value="1080">1080px</option>
                        </select>
                    </div>
                    <div class="option-group">
                        <label>Target Size (Auto):</label>
                        <div class="preset-buttons">
                            <button class="preset-btn" data-target="204800">200KB</button>
                            <button class="preset-btn" data-target="512000">500KB</button>
                            <button class="preset-btn" data-target="1048576">1MB</button>
                            <button class="preset-btn active" data-target="0">Manual</button>
                        </div>
                    </div>
                </div>
                <button class="convert-button" disabled>Start Compression</button>
                <div class="progress-bar"><div class="progress-bar-inner"></div><div class="progress-text">0%</div></div>
                <div class="error-message"></div>
                <div class="results"></div>
            </div>

            <!-- Tab Content: OCR -->
            <div id="ocr" class="tab-content">
                <h2>Extract Text from Image (OCR)</h2>
                <p style="font-size: 0.9rem; color: var(--secondary-color); margin-bottom: 1rem;">
                    ðŸ”’ Images are processed entirely on your device and are never uploaded to a server.
                </p>
                <div class="file-drop-area">
                    <input type="file" class="file-input" accept="image/*">
                    <p>Drag and drop an image here or</p>
                    <label class="file-label">Select Image</label>
                </div>
                
                <div class="options">
                    <div class="preprocessing-options">
                        <div class="checkbox-group">
                            <input type="checkbox" id="ocr-grayscale" checked>
                            <label for="ocr-grayscale">Grayscale</label>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="ocr-contrast" checked>
                            <label for="ocr-contrast">Boost Contrast</label>
                        </div>
                    </div>
                    <div class="option-group">
                        <label for="ocr-threshold">Binarization Threshold:</label>
                        <input type="range" id="ocr-threshold" min="0" max="255" value="128">
                        <span id="threshold-value">128</span>
                    </div>
                </div>

                <button class="convert-button" id="ocr-start-btn" disabled>Start Extraction</button>
                
                <div class="progress-bar" id="ocr-progress-container">
                    <div class="progress-bar-inner" id="ocr-progress-bar"></div>
                    <div class="progress-text" id="ocr-progress-text">Ready</div>
                </div>

                <textarea id="ocr-result-area" placeholder="Extracted text will appear here..." readonly></textarea>
                
                <div class="ocr-controls">
                    <button class="ocr-btn copy" id="ocr-copy-btn">Copy to Clipboard</button>
                    <button class="ocr-btn download" id="ocr-download-btn">Download .txt</button>
                    <button class="ocr-btn reset" id="ocr-reset-btn">Reset</button>
                </div>
                <div class="error-message" id="ocr-error"></div>
            </div>

            <!-- Tab Content: JPG to PDF -->
            <div id="jpg-to-pdf" class="tab-content">
                <h2>Convert JPG to PDF</h2>
                <div class="file-drop-area">
                    <input type="file" class="file-input" multiple accept=".jpg, .jpeg">
                    <p>Drag and drop JPG files here or</p>
                    <label class="file-label">Select Files (Multiple Allowed)</label>
                </div>
                <button class="convert-button" disabled>Convert to PDF</button>
                <div class="progress-bar"><div class="progress-bar-inner"></div><div class="progress-text">0%</div></div>
                <div class="error-message"></div>
                <div class="results"></div>
            </div>

            <!-- Tab Content: Favicon Maker -->
            <div id="favicon" class="tab-content">
                 <h2>Create Favicon (PNG, JPG)</h2>
                <div class="file-drop-area">
                    <input type="file" class="file-input" accept=".png, .jpg, .jpeg">
                    <p>Drag and drop an image here or</p>
                    <label class="file-label">Select File (Only 1)</label>
                </div>
                <button class="convert-button" disabled>Generate Favicon</button>
                <div class="progress-bar"><div class="progress-bar-inner"></div><div class="progress-text">0%</div></div>
                <div class="error-message"></div>
                <div class="results"></div>
            </div>
        </main>

        <section style="margin-top: 4rem; padding: 2rem; background: var(--card-bg); border-radius: 12px; box-shadow: 0 4px 12px var(--shadow-color);">
            <h3>Frequently Asked Questions (FAQ)</h3>
            <div style="display: grid; gap: 1.5rem;">
                <div>
                    <h4 style="color: var(--primary-color);">Is it safe to use this tool?</h4>
                    <p>Yes. All image processing happens locally in your browser. We never upload your files to any server, ensuring 100% privacy.</p>
                </div>
                <div>
                    <h4 style="color: var(--primary-color);">What formats are supported?</h4>
                    <p>We support HEIC, WEBP, PNG, and JPG. You can convert between these formats and also generate PDFs or Favicons.</p>
                </div>
                <div>
                    <h4 style="color: var(--primary-color);">How does the "OCR" feature work?</h4>
                    <p>It uses Tesseract.js to analyze images and extract text. This is useful for copying text from scanned documents or screenshots without typing them out manually.</p>
                </div>
            </div>
        </section>

        <!-- ê´‘ê³  ì˜ì—­ (Ad Area) -->
        <div style="margin: 30px 0; text-align: center;">
            <p style="font-size: 0.8rem; color: var(--secondary-color); margin-bottom: 10px;">Advertisement</p>
            <ins class="adsbygoogle"
              style="display:block"
              data-ad-client="ca-pub-6460078490158642"
              data-ad-slot="1234567890"
              data-ad-format="auto"
              data-full-width-responsive="true"></ins>
            <script>
            (adsbygoogle = window.adsbygoogle || []).push({});
            </script>
        </div>

        <footer>
            <p>ðŸ”’ All conversions are processed on your device. Files are never uploaded to our servers.</p>
            <nav>
                <a href="about.html">About</a>
                <a href="privacy.html">Privacy Policy</a>
                <a href="terms.html">Terms of Service</a>
                <a href="contact.html">Contact</a>
            </nav>
        </footer>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- Theme Logic ---
        const themeToggle = document.getElementById('theme-toggle');
        const themeIcon = themeToggle.querySelector('.theme-icon');
        const themeText = themeToggle.querySelector('.theme-text');
        const html = document.documentElement;

        const savedTheme = localStorage.getItem('theme') || 'light';
        setTheme(savedTheme);

        themeToggle.addEventListener('click', () => {
            const currentTheme = html.getAttribute('data-theme') || 'light';
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            setTheme(newTheme);
        });

        function setTheme(theme) {
            html.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme);
            if (theme === 'dark') {
                themeIcon.textContent = 'â˜€ï¸';
                themeText.textContent = 'Light Mode';
            } else {
                themeIcon.textContent = 'ðŸŒ™';
                themeText.textContent = 'Dark Mode';
            }
        }

        // --- Library instances ---
        const { jsPDF } = window.jspdf;
        const JSZip = window.JSZip;

        // --- Global state ---
        const fileStore = new Map(); // tabId -> FileList
        let currentTargetSize = 0; // for compress tab

        // --- DOM Elements ---
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');

        // --- Tab Switching Logic ---
        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                const tabId = button.dataset.tab;
                tabButtons.forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                tabContents.forEach(content => {
                    content.classList.toggle('active', content.id === tabId);
                });
                const currentFiles = fileStore.get(tabId);
                updateSelectedFilesDisplay(document.getElementById(tabId), currentFiles);
            });
        });

        // --- File Input and Drag & Drop Logic ---
        tabContents.forEach(tab => {
            const dropArea = tab.querySelector('.file-drop-area');
            const fileInput = tab.querySelector('.file-input');
            const fileLabel = tab.querySelector('.file-label');
            const convertButton = tab.querySelector('.convert-button');
            const tabId = tab.id;

            if (!dropArea || !fileInput) return;

            fileLabel.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', () => handleFiles(fileInput.files));
            dropArea.addEventListener('dragover', (e) => { e.preventDefault(); dropArea.classList.add('dragover'); });
            dropArea.addEventListener('dragleave', () => dropArea.classList.remove('dragover'));
            dropArea.addEventListener('drop', (e) => {
                e.preventDefault();
                dropArea.classList.remove('dragover');
                handleFiles(e.dataTransfer.files);
            });
            
            function handleFiles(files) {
                if (files.length > 0) {
                    fileStore.set(tabId, files);
                    updateSelectedFilesDisplay(tab, files);
                    if (convertButton) convertButton.disabled = false;
                }
            }

            if (convertButton) {
                convertButton.addEventListener('click', () => {
                    const files = fileStore.get(tabId);
                    if (files && files.length > 0) executeConversion(tabId, files);
                });
            }
            
            const qualitySlider = tab.querySelector('input[type="range"]');
            if (qualitySlider) {
                const qualityValueSpan = tab.querySelector('.quality-value');
                qualitySlider.addEventListener('input', (e) => {
                    if (qualityValueSpan) qualityValueSpan.textContent = e.target.value;
                });
            }
        });

        // --- Compress Tab Specific Logic ---
        const compressTab = document.getElementById('compress');
        const presetBtns = compressTab.querySelectorAll('.preset-btn');
        presetBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                presetBtns.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentTargetSize = parseInt(btn.dataset.target);
                const qualityInput = compressTab.querySelector('#compress-quality');
                if (currentTargetSize > 0) {
                    qualityInput.disabled = true;
                    compressTab.querySelector('.quality-value').textContent = 'Auto';
                } else {
                    qualityInput.disabled = false;
                    compressTab.querySelector('.quality-value').textContent = qualityInput.value;
                }
            });
        });

        // --- OCR Tab Specific Logic ---
        const ocrTab = document.getElementById('ocr');
        const ocrStartBtn = document.getElementById('ocr-start-btn');
        const ocrResultArea = document.getElementById('ocr-result-area');
        const ocrProgressContainer = document.getElementById('ocr-progress-container');
        const ocrProgressBar = document.getElementById('ocr-progress-bar');
        const ocrProgressText = document.getElementById('ocr-progress-text');
        const ocrThresholdInput = document.getElementById('ocr-threshold');
        const thresholdValueSpan = document.getElementById('threshold-value');

        ocrThresholdInput.addEventListener('input', (e) => {
            thresholdValueSpan.textContent = e.target.value;
        });

        document.getElementById('ocr-copy-btn').addEventListener('click', () => {
            ocrResultArea.select();
            document.execCommand('copy');
            alert('Text copied to clipboard.');
        });

        document.getElementById('ocr-download-btn').addEventListener('click', () => {
            const text = ocrResultArea.value;
            if (!text) return;
            const blob = new Blob([text], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'extracted_text.txt';
            a.click();
        });

        document.getElementById('ocr-reset-btn').addEventListener('click', () => {
            ocrResultArea.value = '';
            fileStore.delete('ocr');
            updateSelectedFilesDisplay(ocrTab, null);
            ocrStartBtn.disabled = true;
            ocrProgressContainer.style.display = 'none';
            ocrProgressBar.style.width = '0%';
            ocrProgressText.textContent = 'Ready';
        });

        /**
         * Main execution router
         */
        async function executeConversion(tabId, files) {
            const tab = document.getElementById(tabId);
            setInProgress(tab, true);
            clearResultsAndErrors(tab);

            try {
                let results = [];
                switch (tabId) {
                    case 'heic-to-jpg':
                        results = await convertHeicToJpg(files, tab);
                        break;
                    case 'webp-to-jpg':
                        results = await convertImageToFormat(files, tab, 'image/jpeg', '.jpg');
                        break;
                    case 'png-to-jpg':
                        const q1 = tab.querySelector('#png-to-jpg-quality').value;
                        results = await convertImageToFormat(files, tab, 'image/jpeg', '.jpg', q1);
                        break;
                    case 'jpg-to-png':
                        results = await convertImageToFormat(files, tab, 'image/png', '.png');
                        break;
                    case 'compress':
                        results = await compressImagesLogic(files, tab);
                        break;
                    case 'ocr':
                        await performOCR(files[0], tab);
                        break;
                    case 'jpg-to-pdf':
                        results = await convertJpgToPdf(files, tab);
                        break;
                    case 'favicon':
                        results = await createFavicon(files[0], tab);
                        break;
                }
                
                if (results.length > 0) displayResults(tab, results);

            } catch (error) {
                console.error('Error:', error);
                displayError(tab, `Error: ${error.message}`);
            } finally {
                setInProgress(tab, false);
            }
        }

        // --- Logic Functions ---

        async function compressImagesLogic(files, tab) {
            const results = [];
            const progressBar = tab.querySelector('.progress-bar-inner');
            const progressText = tab.querySelector('.progress-text');
            const targetWidth = tab.querySelector('#compress-resize').value;
            const manualQuality = parseFloat(tab.querySelector('#compress-quality').value);

            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const percentage = Math.round((i / files.length) * 100);
                updateProgress(progressBar, progressText, percentage);

                const blob = await new Promise((resolve, reject) => {
                    const img = new Image();
                    img.onload = async () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;

                        if (targetWidth !== 'original') {
                            const tw = parseInt(targetWidth);
                            if (width > tw) {
                                height = (tw / width) * height;
                                width = tw;
                            }
                        }
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);

                        if (currentTargetSize > 0) { // Auto adjust quality
                            let low = 0.1, high = 0.95, bestBlob = null;
                            for (let j = 0; j < 6; j++) {
                                const mid = (low + high) / 2;
                                const b = await new Promise(r => canvas.toBlob(r, 'image/jpeg', mid));
                                if (b.size <= currentTargetSize) {
                                    bestBlob = b;
                                    low = mid;
                                } else {
                                    high = mid;
                                }
                            }
                            resolve(bestBlob || (await new Promise(r => canvas.toBlob(r, 'image/jpeg', 0.1))));
                        } else {
                            canvas.toBlob(resolve, 'image/jpeg', manualQuality);
                        }
                    };
                    img.onerror = () => reject(new Error(`Failed to load ${file.name}`));
                    img.src = URL.createObjectURL(file);
                });
                results.push({ name: file.name.replace(/\.[^/.]+$/, "") + "_compressed.jpg", blob, originalSize: file.size });
            }
            updateProgress(progressBar, progressText, 100);
            return results;
        }

        async function performOCR(file, tab) {
            ocrProgressContainer.style.display = 'block';
            ocrResultArea.value = 'Processing image...';
            
            try {
                // Preprocessing
                const processedImg = await preprocessImage(file);
                
                const worker = await Tesseract.createWorker('eng+kor', 1, {
                    logger: m => {
                        if (m.status === 'recognizing text') {
                            const p = Math.round(m.progress * 100);
                            updateProgress(ocrProgressBar, ocrProgressText, p);
                        } else {
                            ocrProgressText.textContent = m.status;
                        }
                    }
                });

                const { data: { text } } = await worker.recognize(processedImg);
                ocrResultArea.value = text || 'No text extracted.';
                await worker.terminate();
            } catch (e) {
                throw new Error('Error during OCR: ' + e.message);
            }
        }

        async function preprocessImage(file) {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    canvas.width = img.width;
                    canvas.height = img.height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0);
                    
                    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    const data = imageData.data;
                    const isGrayscale = document.getElementById('ocr-grayscale').checked;
                    const isContrast = document.getElementById('ocr-contrast').checked;
                    const threshold = parseInt(document.getElementById('ocr-threshold').value);

                    for (let i = 0; i < data.length; i += 4) {
                        let r = data[i], g = data[i+1], b = data[i+2];
                        
                        if (isGrayscale || isContrast) {
                            let gray = 0.299 * r + 0.587 * g + 0.114 * b;
                            if (isContrast) {
                                gray = (gray - 128) * 1.5 + 128; // Simple contrast boost
                            }
                            if (threshold > 0) {
                                gray = gray >= threshold ? 255 : 0;
                            }
                            data[i] = data[i+1] = data[i+2] = gray;
                        }
                    }
                    ctx.putImageData(imageData, 0, 0);
                    resolve(canvas.toDataURL('image/png'));
                };
                img.src = URL.createObjectURL(file);
            });
        }

        // --- Helper Functions ---
        async function convertHeicToJpg(files, tab) {
            const results = [];
            const bar = tab.querySelector('.progress-bar-inner');
            const txt = tab.querySelector('.progress-text');
            for (let i = 0; i < files.length; i++) {
                updateProgress(bar, txt, Math.round((i/files.length)*100));
                try {
                    const blob = await heic2any({ blob: files[i], toType: "image/jpeg", quality: 0.9 });
                    results.push({ name: files[i].name.replace(/\.(heic|heif)$/i, '') + '.jpg', blob, originalSize: files[i].size });
                } catch (e) { displayError(tab, `Failed to convert ${files[i].name}`); }
            }
            updateProgress(bar, txt, 100);
            return results;
        }

        async function convertImageToFormat(files, tab, format, ext, quality) {
            const results = [];
            const bar = tab.querySelector('.progress-bar-inner');
            const txt = tab.querySelector('.progress-text');
            for (let i = 0; i < files.length; i++) {
                updateProgress(bar, txt, Math.round((i/files.length)*100));
                const blob = await new Promise(resolve => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        canvas.width = img.width; canvas.height = img.height;
                        canvas.getContext('2d').drawImage(img, 0, 0);
                        canvas.toBlob(resolve, format, parseFloat(quality) || 0.92);
                    };
                    img.src = URL.createObjectURL(files[i]);
                });
                results.push({ name: files[i].name.split('.').slice(0, -1).join('.') + ext, blob, originalSize: files[i].size });
            }
            updateProgress(bar, txt, 100);
            return results;
        }

        async function convertJpgToPdf(files, tab) {
            const pdf = new jsPDF();
            for (let i = 0; i < files.length; i++) {
                const dataUrl = await new Promise(r => {
                    const reader = new FileReader();
                    reader.onload = e => r(e.target.result);
                    reader.readAsDataURL(files[i]);
                });
                if (i > 0) pdf.addPage();
                pdf.addImage(dataUrl, 'JPEG', 0, 0, 210, 297); // Simplified A4 fit
            }
            return [{ name: 'converted.pdf', blob: pdf.output('blob'), originalSize: 0 }];
        }

        async function createFavicon(file, tab) {
            const zip = new JSZip();
            const source = await new Promise(r => {
                const img = new Image(); img.onload = () => r(img);
                img.src = URL.createObjectURL(file);
            });
            const sizes = [16, 32, 48, 64];
            for (const s of sizes) {
                const canvas = document.createElement('canvas');
                canvas.width = canvas.height = s;
                canvas.getContext('2d').drawImage(source, 0, 0, s, s);
                const b = await new Promise(r => canvas.toBlob(r, 'image/png'));
                zip.file(`favicon-${s}x${s}.png`, b);
            }
            const zipBlob = await zip.generateAsync({ type: 'blob' });
            return [{ name: 'favicon-package.zip', blob: zipBlob, originalSize: file.size, noPreview: true }];
        }

        function displayResults(tab, resultsData) {
            const container = tab.querySelector('.results');
            container.innerHTML = '';
            if (resultsData.length > 1) {
                const zip = new JSZip();
                resultsData.forEach(r => zip.file(r.name, r.blob));
                zip.generateAsync({ type: 'blob' }).then(b => {
                    container.appendChild(createResultItem({ name: 'all_files.zip', blob: b, originalSize: 0, noPreview: true }));
                });
            }
            resultsData.forEach(r => container.appendChild(createResultItem(r)));
        }

        function createResultItem(res) {
            const div = document.createElement('div');
            div.className = 'result-item';
            const url = URL.createObjectURL(res.blob);
            const reduction = res.originalSize ? Math.round((1 - res.blob.size/res.originalSize)*100) : 0;
            div.innerHTML = `
                ${res.noPreview ? '' : `<img src="${url}">`}
                <div class="result-info">
                    <strong>${res.name}</strong>
                    <p>${formatBytes(res.blob.size)} ${reduction > 0 ? `(${reduction}% reduced)` : ''}</p>
                </div>
                <a href="${url}" download="${res.name}" class="download-button">Download</a>
            `;
            return div;
        }

        function updateSelectedFilesDisplay(tab, files) {
            const p = tab.querySelector('.file-drop-area p');
            if (!files || files.length === 0) p.textContent = 'Select or drag files here.';
            else p.textContent = files.length === 1 ? `Selected: ${files[0].name}` : `${files.length} files selected`;
        }

        function setInProgress(tab, busy) {
            const btn = tab.querySelector('.convert-button');
            const bar = tab.querySelector('.progress-bar');
            if (btn) btn.disabled = busy;
            if (bar) bar.style.display = busy ? 'block' : 'none';
        }

        function updateProgress(bar, text, p) {
            if (bar) bar.style.width = p + '%';
            if (text) text.textContent = p + '%';
        }

        function clearResultsAndErrors(tab) {
            const r = tab.querySelector('.results');
            const e = tab.querySelector('.error-message');
            if (r) r.innerHTML = '';
            if (e) { e.textContent = ''; e.style.display = 'none'; }
        }

        function displayError(tab, msg) {
            const e = tab.querySelector('.error-message');
            if (e) { e.textContent = msg; e.style.display = 'block'; }
        }

        function formatBytes(b) {
            if (b === 0) return '0 B';
            const i = Math.floor(Math.log(b) / Math.log(1024));
            return (b / Math.pow(1024, i)).toFixed(2) * 1 + ' ' + ['B', 'KB', 'MB', 'GB'][i];
        }
    });
    </script>

</body>
</html>