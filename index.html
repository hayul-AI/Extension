<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Tools - Pro Browser Utility</title>
    <meta name="description" content="Free online image converter. Convert HEIC to JPG, WEBP to JPG, PNG to JPG, compress images, extract text with OCR, merge JPG to PDF, and generate favicons securely in your browser.">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6460078490158642" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/heic2any/0.0.4/heic2any.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <style>
        :root {
            --brand-primary: #6366f1;
            --brand-secondary: #8b5cf6;
            --brand-success: #10b981;
            --brand-danger: #f43f5e;
            --bg-light: #f8fafc;
            --bg-dark: #0f172a;
            --text-light: #1e293b;
            --text-dark: #f1f5f9;
            --glass-light: rgba(255, 255, 255, 0.85);
            --glass-dark: rgba(30, 41, 59, 0.85);
            --border-light: rgba(255, 255, 255, 0.3);
            --border-dark: rgba(255, 255, 255, 0.08);
            --radius-xl: 28px;
            --radius-lg: 20px;
            --shadow-float: 0 25px 50px -12px rgba(0, 0, 0, 0.15);
        }

        [data-theme="dark"] {
            --bg-base: var(--bg-dark);
            --text-base: var(--text-dark);
            --glass-base: var(--glass-dark);
            --border-base: var(--border-dark);
            --secondary-color: #94a3b8;
        }

        [data-theme="light"] {
            --bg-base: var(--bg-light);
            --text-base: var(--text-light);
            --glass-base: var(--glass-light);
            --border-base: var(--border-light);
            --secondary-color: #64748b;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 10px; }
        ::-webkit-scrollbar-track { background: var(--bg-base); }
        ::-webkit-scrollbar-thumb { 
            background: var(--border-base); 
            border-radius: 10px; 
            border: 3px solid var(--bg-base);
        }
        ::-webkit-scrollbar-thumb:hover { background: var(--secondary-color); }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: var(--bg-base);
            color: var(--text-base);
            line-height: 1.6;
            transition: background-color 0.5s ease, color 0.5s ease;
            overflow-x: hidden;
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
        }

        .bg-blobs {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            overflow: hidden;
            filter: blur(100px);
            opacity: 0.5;
        }

        .blob {
            position: absolute;
            width: 50vw;
            height: 50vw;
            border-radius: 50%;
            animation: move 25s infinite alternate ease-in-out;
        }

        .blob-1 { top: -10%; left: -10%; background: var(--brand-primary); }
        .blob-2 { bottom: -10%; right: -10%; background: var(--brand-secondary); animation-delay: -7s; }
        .blob-3 { top: 30%; left: 20%; background: #ec4899; animation-duration: 30s; opacity: 0.3; }

        @keyframes move {
            0% { transform: translate(0, 0) scale(1) rotate(0deg); }
            100% { transform: translate(15vw, 20vh) scale(1.3) rotate(90deg); }
        }

        .container {
            width: 95%;
            max-width: 1050px;
            margin: 0 auto;
            padding: 2.5rem 1rem;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5rem;
        }

        .hero {
            text-align: center;
            margin-bottom: 5rem;
        }

        .hero h1 {
            font-size: 4rem;
            font-weight: 800;
            letter-spacing: -0.05em;
            margin-bottom: 1.25rem;
            line-height: 1.1;
            background: linear-gradient(135deg, var(--brand-primary), var(--brand-secondary), #ec4899);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .hero p {
            font-size: 1.25rem;
            color: var(--secondary-color);
            max-width: 650px;
            margin: 0 auto;
            font-weight: 500;
        }

        .tabs {
            display: flex;
            flex-wrap: nowrap;
            overflow-x: auto;
            gap: 0.4rem;
            padding: 0.5rem;
            background: var(--glass-base);
            backdrop-filter: blur(30px);
            -webkit-backdrop-filter: blur(30px);
            border: 1px solid var(--border-base);
            border-radius: 24px;
            margin-bottom: 3.5rem;
            scrollbar-width: none;
            box-shadow: var(--shadow-float);
        }

        .tabs::-webkit-scrollbar { display: none; }

        .tab-button {
            padding: 0.8rem 1.75rem;
            font-size: 0.9rem;
            font-weight: 700;
            white-space: nowrap;
            border: none;
            background: transparent;
            color: var(--secondary-color);
            border-radius: 18px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .tab-button:hover {
            color: var(--brand-primary);
            background: rgba(99, 102, 241, 0.08);
        }

        .tab-button.active {
            background: var(--brand-primary);
            color: white;
            box-shadow: 0 12px 20px -5px rgba(99, 102, 241, 0.4);
        }

        .tab-content {
            display: none;
            padding: 3.5rem;
            background: var(--glass-base);
            backdrop-filter: blur(30px);
            -webkit-backdrop-filter: blur(30px);
            border-radius: var(--radius-xl);
            border: 1px solid var(--border-base);
            box-shadow: var(--shadow-float);
            animation: slideUp 0.6s cubic-bezier(0.2, 0.8, 0.2, 1);
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(30px) scale(0.98); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        .tab-content.active { display: block; }

        .file-drop-area {
            border: 2px dashed var(--brand-primary);
            border-radius: var(--radius-lg);
            padding: 6rem 2rem;
            text-align: center;
            background: rgba(99, 102, 241, 0.015);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            position: relative;
        }

        .file-drop-area:hover {
            border-color: var(--brand-secondary);
            background: rgba(99, 102, 241, 0.04);
            transform: translateY(-2px);
        }

        .file-label {
            background: linear-gradient(135deg, var(--brand-primary), var(--brand-secondary));
            padding: 0.9rem 2.5rem;
            border-radius: 14px;
            color: white;
            font-weight: 700;
            display: inline-block;
            margin-top: 1.5rem;
            transition: all 0.3s;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }

        .file-label:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(99, 102, 241, 0.4);
        }

        .convert-button {
            display: block;
            width: 100%;
            padding: 1.125rem;
            font-size: 1.125rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--brand-success), #059669);
            color: white;
            border: none;
            border-radius: 16px;
            cursor: pointer;
            margin-top: 2.5rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 10px 15px -3px rgba(16, 185, 129, 0.3);
        }

        .convert-button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 20px 25px -5px rgba(16, 185, 129, 0.4);
            filter: brightness(1.1);
        }

        .convert-button:disabled {
            background: var(--secondary-color);
            opacity: 0.4;
            cursor: not-allowed;
            box-shadow: none;
        }

        .progress-bar {
            width: 100%;
            height: 14px;
            background-color: var(--border-base);
            border-radius: 9999px;
            margin-top: 2.5rem;
            overflow: hidden;
            display: none;
        }

        .progress-bar-inner {
            width: 0;
            height: 100%;
            background: linear-gradient(90deg, var(--brand-primary), #ec4899, var(--brand-secondary));
            background-size: 200% 100%;
            animation: shimmer 2s infinite linear;
            transition: width 0.4s ease;
        }

        @keyframes shimmer {
            0% { background-position: 100% 0; }
            100% { background-position: -100% 0; }
        }

        .result-item {
            background: var(--glass-base);
            border: 1px solid var(--border-base);
            padding: 1.5rem;
            border-radius: 22px;
            display: flex;
            align-items: center;
            gap: 1.5rem;
            margin-bottom: 1.25rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .result-item:hover {
            transform: scale(1.02);
            border-color: var(--brand-primary);
            background: white;
        }

        [data-theme="dark"] .result-item:hover { background: #1e293b; }

        .result-item img {
            width: 80px;
            height: 80px;
            border-radius: 14px;
            object-fit: cover;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .theme-toggle {
            padding: 0.7rem 1.4rem;
            background: var(--glass-base);
            border: 1px solid var(--border-base);
            border-radius: 16px;
            cursor: pointer;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 0.6rem;
            transition: all 0.3s;
        }

        .theme-toggle:hover { background: var(--bg-base); transform: scale(1.05); }

        .faq-section {
            margin-top: 8rem;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2.5rem;
        }

        .faq-card {
            background: var(--glass-base);
            padding: 2.5rem;
            border-radius: var(--radius-xl);
            border: 1px solid var(--border-base);
            transition: all 0.3s;
        }

        .faq-card:hover { transform: translateY(-5px); border-color: var(--brand-primary); }

        .faq-card h4 {
            color: var(--brand-primary);
            margin-bottom: 1.25rem;
            font-size: 1.25rem;
            font-weight: 800;
        }

        footer {
            margin-top: 10rem;
            padding: 5rem 0;
            text-align: center;
            border-top: 1px solid var(--border-base);
        }

        .nav-links a {
            color: var(--secondary-color);
            text-decoration: none;
            font-weight: 700;
            margin: 0 1.5rem;
            transition: color 0.3s;
            font-size: 0.95rem;
        }

        .nav-links a:hover { color: var(--brand-primary); }

        #ocr-result-area {
            width: 100%;
            height: 300px;
            margin-top: 2rem;
            padding: 1.5rem;
            border-radius: 18px;
            border: 1px solid var(--border-base);
            background: rgba(0,0,0,0.02);
            color: var(--text-base);
            font-size: 1rem;
            line-height: 1.7;
            resize: vertical;
        }

        .preset-btn {
            padding: 0.5rem 1rem;
            font-size: 0.8rem;
            font-weight: 700;
            border: 1px solid var(--border-base);
            background: transparent;
            color: var(--secondary-color);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .preset-btn.active {
            background: var(--brand-primary);
            color: white;
            border-color: var(--brand-primary);
        }

        @media (max-width: 768px) {
            .hero h1 { font-size: 2.75rem; }
            .tab-content { padding: 2rem 1.5rem; }
            .container { padding: 1.5rem 1rem; }
            .tabs { border-radius: 18px; }
        }
    </style>
</head>
<body data-theme="light">
    <div class="bg-blobs">
        <div class="blob blob-1"></div>
        <div class="blob blob-2"></div>
        <div class="blob blob-3"></div>
    </div>

    <div class="container">
        <header>
            <div class="header-title" style="display: flex; align-items: center; gap: 0.75rem;">
                <svg width="36" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" style="color: var(--brand-primary);">
                    <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
                    <polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline>
                    <line x1="12" y1="22.08" x2="12" y2="12"></line>
                </svg>
                <span style="font-weight: 800; font-size: 1.4rem; letter-spacing: -0.03em;">ImageTools <span style="font-weight: 400; color: var(--secondary-color);">Pro</span></span>
            </div>
            <button class="theme-toggle" id="theme-toggle">
                <span class="theme-icon">ðŸŒ™</span>
                <span class="theme-text">Dark Mode</span>
            </button>
        </header>

        <section class="hero">
            <h1>Smarter Images,<br>Better Privacy.</h1>
            <p>Convert, compress, and extract text from your photos with pro-grade speed. All processing happens 100% on your device.</p>
        </section>

        <nav class="tabs">
            <button class="tab-button active" data-tab="heic-to-jpg">HEIC to JPG</button>
            <button class="tab-button" data-tab="webp-to-jpg">WEBP to JPG</button>
            <button class="tab-button" data-tab="png-to-jpg">PNG to JPG</button>
            <button class="tab-button" data-tab="jpg-to-png">JPG to PNG</button>
            <button class="tab-button" data-tab="compress">Compress</button>
            <button class="tab-button" data-tab="ocr">OCR</button>
            <button class="tab-button" data-tab="jpg-to-pdf">PDF</button>
            <button class="tab-button" data-tab="favicon">Favicon</button>
        </nav>

        <main>
            <!-- Conversion Tabs -->
            <div id="heic-to-jpg" class="tab-content active">
                <h2>Convert HEIC to JPG</h2>
                <div class="file-drop-area">
                    <p style="font-weight: 700; color: var(--text-base); font-size: 1.1rem; margin-bottom: 0.5rem;">Drop HEIC files here</p>
                    <p style="color: var(--secondary-color); font-size: 0.9rem;">or click to browse your folders</p>
                    <label class="file-label">Select Files</label>
                    <input type="file" class="file-input" multiple accept=".heic, .heif" style="display: none;">
                </div>
                <button class="convert-button" disabled>Generate JPGs</button>
                <div class="progress-bar"><div class="progress-bar-inner"></div></div>
                <div class="results"></div>
            </div>

            <!-- WEBP Tab -->
            <div id="webp-to-jpg" class="tab-content">
                <h2>Convert WEBP to JPG</h2>
                <div class="file-drop-area">
                    <p style="font-weight: 700; color: var(--text-base); font-size: 1.1rem; margin-bottom: 0.5rem;">Drop WEBP files here</p>
                    <label class="file-label">Select Files</label>
                    <input type="file" class="file-input" multiple accept=".webp" style="display: none;">
                </div>
                <button class="convert-button" disabled>Process to JPG</button>
                <div class="progress-bar"><div class="progress-bar-inner"></div></div>
                <div class="results"></div>
            </div>

            <!-- PNG Tab -->
            <div id="png-to-jpg" class="tab-content">
                <h2>Convert PNG to JPG</h2>
                <div class="file-drop-area">
                    <p style="font-weight: 700; color: var(--text-base); font-size: 1.1rem; margin-bottom: 0.5rem;">Drop PNG images here</p>
                    <label class="file-label">Select Files</label>
                    <input type="file" class="file-input" multiple accept=".png" style="display: none;">
                </div>
                <div class="options">
                    <div class="option-group">
                        <label>Output Quality:</label>
                        <input type="range" id="png-to-jpg-quality" min="0.1" max="1.0" value="0.92" step="0.01">
                        <span class="quality-value" style="font-weight: 800; min-width: 40px;">0.92</span>
                    </div>
                </div>
                <button class="convert-button" disabled>Convert Now</button>
                <div class="progress-bar"><div class="progress-bar-inner"></div></div>
                <div class="results"></div>
            </div>

            <!-- JPG to PNG Tab -->
            <div id="jpg-to-png" class="tab-content">
                 <h2>Convert JPG to PNG</h2>
                <div class="file-drop-area">
                    <p style="font-weight: 700; color: var(--text-base); font-size: 1.1rem; margin-bottom: 0.5rem;">Drop JPG photos here</p>
                    <label class="file-label">Select Files</label>
                    <input type="file" class="file-input" multiple accept=".jpg, .jpeg" style="display: none;">
                </div>
                <button class="convert-button" disabled>Convert to PNG</button>
                <div class="progress-bar"><div class="progress-bar-inner"></div></div>
                <div class="results"></div>
            </div>

            <!-- Compress Tab -->
            <div id="compress" class="tab-content">
                <h2>Optimize & Compress</h2>
                <div class="file-drop-area">
                    <p style="font-weight: 700; color: var(--text-base); font-size: 1.1rem; margin-bottom: 0.5rem;">Drop images to reduce size</p>
                    <label class="file-label">Select Files</label>
                    <input type="file" class="file-input" multiple accept=".jpg, .jpeg, .png, .webp" style="display: none;">
                </div>
                 <div class="options">
                    <div class="option-group">
                        <label>Quality:</label>
                        <input type="range" id="compress-quality" min="0.4" max="0.95" value="0.8" step="0.01">
                        <span class="quality-value" style="font-weight: 800; min-width: 40px;">0.8</span>
                    </div>
                    <div class="option-group">
                        <label>Max Width:</label>
                        <select id="compress-resize" style="padding: 0.6rem; border-radius: 12px; border: 1px solid var(--border-base); background: var(--bg-base); color: inherit; font-weight: 600;">
                            <option value="original">Keep Original</option>
                            <option value="1920">1920px (Full HD)</option>
                            <option value="1280">1280px (HD)</option>
                            <option value="1080">1080px</option>
                        </select>
                    </div>
                    <div class="option-group">
                        <label>Target File Size:</label>
                        <div class="preset-buttons">
                            <button class="preset-btn" data-target="204800">200KB</button>
                            <button class="preset-btn" data-target="512000">500KB</button>
                            <button class="preset-btn" data-target="1048576">1MB</button>
                            <button class="preset-btn active" data-target="0">Manual</button>
                        </div>
                    </div>
                </div>
                <button class="convert-button" disabled>Compress Images</button>
                <div class="progress-bar"><div class="progress-bar-inner"></div></div>
                <div class="results"></div>
            </div>

            <!-- OCR Tab -->
            <div id="ocr" class="tab-content">
                <h2>Text Recognition (OCR)</h2>
                <div class="file-drop-area">
                    <p style="font-weight: 700; color: var(--text-base); font-size: 1.1rem; margin-bottom: 0.5rem;">Drop image with text</p>
                    <label class="file-label">Select Image</label>
                    <input type="file" class="file-input" accept="image/*" style="display: none;">
                </div>
                <div class="options">
                    <div style="display: flex; gap: 2rem; margin-bottom: 1.5rem;">
                        <label style="display: flex; align-items: center; gap: 0.6rem; font-weight: 600; cursor: pointer;"><input type="checkbox" id="ocr-grayscale" checked style="width: 18px; height: 18px;"> Grayscale</label>
                        <label style="display: flex; align-items: center; gap: 0.6rem; font-weight: 600; cursor: pointer;"><input type="checkbox" id="ocr-contrast" checked style="width: 18px; height: 18px;"> Sharp Contrast</label>
                    </div>
                    <div class="option-group">
                        <label>Threshold:</label>
                        <input type="range" id="ocr-threshold" min="0" max="255" value="128">
                        <span id="threshold-value" style="font-weight: 800; min-width: 40px;">128</span>
                    </div>
                </div>
                <button class="convert-button" id="ocr-start-btn" disabled>Scan for Text</button>
                <div class="progress-bar" id="ocr-progress-container"><div class="progress-bar-inner" id="ocr-progress-bar"></div></div>
                <textarea id="ocr-result-area" placeholder="Extracted text will appear here..." readonly></textarea>
                <div class="ocr-controls">
                    <button class="ocr-btn copy" id="ocr-copy-btn">Copy Text</button>
                    <button class="ocr-btn download" id="ocr-download-btn">Save as TXT</button>
                    <button class="ocr-btn reset" id="ocr-reset-btn">Reset</button>
                </div>
            </div>

            <!-- PDF Tab -->
            <div id="jpg-to-pdf" class="tab-content">
                <h2>Merge to PDF</h2>
                <div class="file-drop-area">
                    <p style="font-weight: 700; color: var(--text-base); font-size: 1.1rem; margin-bottom: 0.5rem;">Drop images to merge</p>
                    <label class="file-label">Select Files</label>
                    <input type="file" class="file-input" multiple accept=".jpg, .jpeg" style="display: none;">
                </div>
                <button class="convert-button" disabled>Generate PDF</button>
                <div class="progress-bar"><div class="progress-bar-inner"></div></div>
                <div class="results"></div>
            </div>

            <!-- Favicon Tab -->
            <div id="favicon" class="tab-content">
                 <h2>Generate Favicon</h2>
                <div class="file-drop-area">
                    <p style="font-weight: 700; color: var(--text-base); font-size: 1.1rem; margin-bottom: 0.5rem;">Drop brand logo (1:1 ratio)</p>
                    <label class="file-label">Select File</label>
                    <input type="file" class="file-input" accept=".png, .jpg, .jpeg" style="display: none;">
                </div>
                <button class="convert-button" disabled>Create Favicon Pack</button>
                <div class="progress-bar"><div class="progress-bar-inner"></div></div>
                <div class="results"></div>
            </div>
        </main>

        <section class="faq-section">
            <div class="faq-card">
                <h4>Privacy First</h4>
                <p>We believe in absolute data ownership. That's why we built this tool to run entirely in your local RAM. No uploads, no logs, no risks.</p>
            </div>
            <div class="faq-card">
                <h4>Pro Formats</h4>
                <p>Handle modern web formats like WEBP and Apple's HEIC effortlessly. Perfect for developers and photography enthusiasts alike.</p>
            </div>
            <div class="faq-card">
                <h4>Fast & Simple</h4>
                <p>Optimized algorithms ensure that even batch processing of 50+ images is fast and fluid. Free to use with zero registration.</p>
            </div>
        </section>

        <footer>
            <div class="nav-links">
                <a href="about.html">About</a>
                <a href="privacy.html">Privacy</a>
                <a href="terms.html">Terms</a>
                <a href="contact.html">Contact</a>
            </div>
            <p style="font-size: 0.9rem; color: var(--secondary-color); font-weight: 500;">Â© 2024 ImageTools Pro. Built for Privacy.</p>
        </footer>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const themeToggle = document.getElementById('theme-toggle');
        const themeIcon = themeToggle.querySelector('.theme-icon');
        const themeText = themeToggle.querySelector('.theme-text');
        const body = document.body;

        const savedTheme = localStorage.getItem('theme') || 'light';
        setTheme(savedTheme);

        themeToggle.addEventListener('click', () => {
            const currentTheme = body.getAttribute('data-theme');
            setTheme(currentTheme === 'light' ? 'dark' : 'light');
        });

        function setTheme(theme) {
            body.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme);
            themeIcon.textContent = theme === 'dark' ? 'â˜€ï¸' : 'ðŸŒ™';
            themeText.textContent = theme === 'dark' ? 'Light Mode' : 'Dark Mode';
        }

        const JSZip = window.JSZip;
        const { jsPDF } = window.jspdf;
        const fileStore = new Map();
        let currentTargetSize = 0;

        const tabButtons = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');

        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                const tabId = button.dataset.tab;
                tabButtons.forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                tabContents.forEach(content => content.classList.toggle('active', content.id === tabId));
                const currentFiles = fileStore.get(tabId);
                updateSelectedFilesDisplay(document.getElementById(tabId), currentFiles);
            });
        });

        tabContents.forEach(tab => {
            const dropArea = tab.querySelector('.file-drop-area');
            const fileInput = tab.querySelector('.file-input');
            const convertButton = tab.querySelector('.convert-button');
            const tabId = tab.id;

            if (!dropArea || !fileInput) return;

            dropArea.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', () => handleFiles(fileInput.files));
            
            ['dragover', 'dragleave', 'drop'].forEach(evt => {
                dropArea.addEventListener(evt, e => {
                    e.preventDefault();
                    e.stopPropagation();
                    if (evt === 'dragover') dropArea.classList.add('dragover');
                    if (evt === 'dragleave' || evt === 'drop') dropArea.classList.remove('dragover');
                    if (evt === 'drop') handleFiles(e.dataTransfer.files);
                });
            });
            
            function handleFiles(files) {
                if (files.length > 0) {
                    fileStore.set(tabId, files);
                    updateSelectedFilesDisplay(tab, files);
                    if (convertButton) convertButton.disabled = false;
                }
            }

            if (convertButton) {
                convertButton.addEventListener('click', e => {
                    e.stopPropagation();
                    const files = fileStore.get(tabId);
                    if (files) executeConversion(tabId, files);
                });
            }
            
            const qualitySlider = tab.querySelector('input[type="range"]');
            if (qualitySlider) {
                const qValue = tab.querySelector('.quality-value');
                qualitySlider.addEventListener('input', e => { if (qValue) qValue.textContent = e.target.value; });
            }
        });

        const compressTab = document.getElementById('compress');
        compressTab.querySelectorAll('.preset-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                compressTab.querySelectorAll('.preset-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentTargetSize = parseInt(btn.dataset.target);
                const qInput = compressTab.querySelector('#compress-quality');
                qInput.disabled = currentTargetSize > 0;
                compressTab.querySelector('.quality-value').textContent = currentTargetSize > 0 ? 'Auto' : qInput.value;
            });
        });

        const ocrResult = document.getElementById('ocr-result-area');
        document.getElementById('ocr-copy-btn').addEventListener('click', () => {
            ocrResult.select();
            document.execCommand('copy');
            alert('Text copied!');
        });

        document.getElementById('ocr-download-btn').addEventListener('click', () => {
            if (!ocrResult.value) return;
            const a = document.createElement('a');
            a.href = URL.createObjectURL(new Blob([ocrResult.value], { type: 'text/plain' }));
            a.download = 'extracted_text.txt';
            a.click();
        });

        document.getElementById('ocr-reset-btn').addEventListener('click', () => {
            ocrResult.value = '';
            fileStore.delete('ocr');
            updateSelectedFilesDisplay(document.getElementById('ocr'), null);
            document.getElementById('ocr-start-btn').disabled = true;
            document.getElementById('ocr-progress-container').style.display = 'none';
        });

        async function executeConversion(tabId, files) {
            const tab = document.getElementById(tabId);
            setInProgress(tab, true);
            const resultsContainer = tab.querySelector('.results');
            resultsContainer.innerHTML = '';

            try {
                let results = [];
                switch (tabId) {
                    case 'heic-to-jpg': results = await convertHeic(files, tab); break;
                    case 'webp-to-jpg': results = await convertCanvas(files, tab, 'image/jpeg', '.jpg'); break;
                    case 'png-to-jpg': results = await convertCanvas(files, tab, 'image/jpeg', '.jpg', tab.querySelector('#png-to-jpg-quality').value); break;
                    case 'jpg-to-png': results = await convertCanvas(files, tab, 'image/png', '.png'); break;
                    case 'compress': results = await compressLogic(files, tab); break;
                    case 'ocr': await performOCR(files[0], tab); break;
                    case 'jpg-to-pdf': results = await convertPdf(files, tab); break;
                    case 'favicon': results = await convertFavicon(files[0], tab); break;
                }
                if (results.length > 0) displayResults(tab, results);
            } catch (e) {
                alert('Error: ' + e.message);
            } finally {
                setInProgress(tab, false);
            }
        }

        async function convertHeic(files, tab) {
            const res = [];
            const bar = tab.querySelector('.progress-bar-inner');
            for (let i = 0; i < files.length; i++) {
                bar.style.width = (i/files.length)*100 + '%';
                const blob = await heic2any({ blob: files[i], toType: 'image/jpeg', quality: 0.9 });
                res.push({ name: files[i].name.replace(/\.[^/.]+$/, "") + '.jpg', blob, originalSize: files[i].size });
            }
            return res;
        }

        async function convertCanvas(files, tab, format, ext, quality) {
            const res = [];
            const bar = tab.querySelector('.progress-bar-inner');
            for (let i = 0; i < files.length; i++) {
                bar.style.width = (i/files.length)*100 + '%';
                const blob = await new Promise(r => {
                    const img = new Image();
                    img.onload = () => {
                        const c = document.createElement('canvas');
                        c.width = img.width; c.height = img.height;
                        c.getContext('2d').drawImage(img, 0, 0);
                        c.toBlob(r, format, parseFloat(quality) || 0.92);
                    };
                    img.src = URL.createObjectURL(files[i]);
                });
                res.push({ name: files[i].name.replace(/\.[^/.]+$/, "") + ext, blob, originalSize: files[i].size });
            }
            return res;
        }

        async function compressLogic(files, tab) {
            const res = [];
            const bar = tab.querySelector('.progress-bar-inner');
            const tw = tab.querySelector('#compress-resize').value;
            const mq = parseFloat(tab.querySelector('#compress-quality').value);

            for (let i = 0; i < files.length; i++) {
                bar.style.width = (i/files.length)*100 + '%';
                const blob = await new Promise(r => {
                    const img = new Image();
                    img.onload = async () => {
                        const c = document.createElement('canvas');
                        let w = img.width, h = img.height;
                        if (tw !== 'original') {
                            const target = parseInt(tw);
                            if (w > target) { h = (target/w)*h; w = target; }
                        }
                        c.width = w; c.height = h;
                        c.getContext('2d').drawImage(img, 0, 0, w, h);
                        if (currentTargetSize > 0) {
                            let low = 0.1, high = 0.95, best = null;
                            for (let j=0; j<6; j++) {
                                const mid = (low+high)/2;
                                const b = await new Promise(ok => c.toBlob(ok, 'image/jpeg', mid));
                                if (b.size <= currentTargetSize) { best = b; low = mid; } else { high = mid; }
                            }
                            r(best || (await new Promise(ok => c.toBlob(ok, 'image/jpeg', 0.1))));
                        } else {
                            c.toBlob(r, 'image/jpeg', mq);
                        }
                    };
                    img.src = URL.createObjectURL(files[i]);
                });
                res.push({ name: files[i].name.replace(/\.[^/.]+$/, "") + "_comp.jpg", blob, originalSize: files[i].size });
            }
            return res;
        }

        async function performOCR(file, tab) {
            const container = document.getElementById('ocr-progress-container');
            const bar = document.getElementById('ocr-progress-bar');
            container.style.display = 'block';
            ocrResult.value = 'Analyzing image...';
            
            const worker = await Tesseract.createWorker('eng+kor', 1, {
                logger: m => { if (m.status === 'recognizing text') bar.style.width = (m.progress*100) + '%'; }
            });
            const { data: { text } } = await worker.recognize(file);
            ocrResult.value = text || 'No text found.';
            await worker.terminate();
        }

        async function convertPdf(files, tab) {
            const pdf = new jsPDF();
            for (let i = 0; i < files.length; i++) {
                if (i > 0) pdf.addPage();
                const dataUrl = await new Promise(r => {
                    const reader = new FileReader();
                    reader.onload = e => r(e.target.result);
                    reader.readAsDataURL(files[i]);
                });
                const img = new Image();
                await new Promise(r => { img.onload = r; img.src = dataUrl; });
                const ratio = img.width / img.height;
                pdf.addImage(dataUrl, 'JPEG', 0, 0, 210, 210/ratio);
            }
            return [{ name: 'merged.pdf', blob: pdf.output('blob'), originalSize: 0 }];
        }

        async function convertFavicon(file, tab) {
            const zip = new JSZip();
            const source = await new Promise(r => {
                const img = new Image(); img.onload = () => r(img);
                img.src = URL.createObjectURL(file);
            });
            for (const s of [16, 32, 48, 64]) {
                const c = document.createElement('canvas');
                c.width = c.height = s;
                c.getContext('2d').drawImage(source, 0, 0, s, s);
                const b = await new Promise(ok => c.toBlob(ok, 'image/png'));
                zip.file(`favicon-${s}x${s}.png`, b);
            }
            const blob = await zip.generateAsync({ type: 'blob' });
            return [{ name: 'favicon_pack.zip', blob, originalSize: file.size, noPreview: true }];
        }

        function displayResults(tab, data) {
            const container = tab.querySelector('.results');
            if (data.length > 1) {
                const zip = new JSZip();
                data.forEach(r => zip.file(r.name, r.blob));
                zip.generateAsync({ type: 'blob' }).then(b => {
                    container.prepend(createResultItem({ name: 'download_all.zip', blob: b, originalSize: 0, noPreview: true }));
                });
            }
            data.forEach(r => container.appendChild(createResultItem(r)));
        }

        function createResultItem(res) {
            const div = document.createElement('div');
            div.className = 'result-item';
            const url = URL.createObjectURL(res.blob);
            const reduction = res.originalSize ? Math.round((1 - res.blob.size/res.originalSize)*100) : 0;
            div.innerHTML = `
                ${res.noPreview ? '' : `<img src="${url}">`}
                <div class="result-info">
                    <strong style="display:block; margin-bottom: 0.25rem;">${res.name}</strong>
                    <p>${formatBytes(res.blob.size)} ${reduction > 0 ? `<span style="color: var(--brand-success); font-weight: 700;">(${reduction}% smaller)</span>` : ''}</p>
                </div>
                <a href="${url}" download="${res.name}" class="download-button">Download</a>
            `;
            return div;
        }

        function updateSelectedFilesDisplay(tab, files) {
            const p = tab.querySelector('.file-drop-area p:first-child');
            if (!p) return;
            p.textContent = (!files || files.length === 0) ? 'Drop files here' : (files.length === 1 ? `Selected: ${files[0].name}` : `${files.length} files selected`);
        }

        function setInProgress(tab, busy) {
            const btn = tab.querySelector('.convert-button');
            const bar = tab.querySelector('.progress-bar');
            if (btn) btn.disabled = busy;
            if (bar) bar.style.display = busy ? 'block' : 'none';
        }

        function formatBytes(b) {
            if (b === 0) return '0 B';
            const i = Math.floor(Math.log(b) / Math.log(1024));
            return (b / Math.pow(1024, i)).toFixed(2) * 1 + ' ' + ['B', 'KB', 'MB', 'GB'][i];
        }
    });
    </script>
</body>
</html>